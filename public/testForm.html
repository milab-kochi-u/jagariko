<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>testForm</title>
    <script src="/tmp/jquery-2.2.4.min.js" ></script>
    <script src="/_debate/d3/d3.js"></script>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
    <script src="/tmp/angular.min.js"></script>
    <style>
        #claim{
            height:250px;
        }

        #claimBody{
            height:200px;
        }

        #resultForm{
            height: 400px;
        }

        #resultFormBody{
            height:380px;
        }



        #input{
            height: 380px;
        }


        #inputBody{
            height:360px;
        }

    </style>
</head>
<body ng-app="myChat">
<div class="container "  ng-controller="chat" >

    <div class="row">
    <nav class="navbar navbar-default" ng-if="LAN=='CN'">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/debateCN/group#/theme">辩论</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li class="active"><a href="#">辩论中<span class="sr-only">(current)</span></a></li>
                    <li><a href="/debateCN/review">回顾</a></li>
                </ul>
                <form class="navbar-form navbar-left" role="search">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="王宝强经得起推敲吗?">
                    </div>
                    <button type="submit" class="btn btn-default">搜索</button>
                </form>
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="">你好:</a></li>
                    <li><a href="#">个人页面</a></li>
                    <!--
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Dropdown <span class="caret"></span></a>
                        <ul class="dropdown-menu">
                            <li><a href="#">Action</a></li>
                            <li><a href="#">Another action</a></li>
                            <li><a href="#">Something else here</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#">Separated link</a></li>
                        </ul>
                    </li>
                    -->
                </ul>
            </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
    </nav>
    </div>


        <div class="row" id="claim">
            <div class="row">
                <div  class="panel panel-info">
                    <div class="panel-heading">文章</div>
                    <div class="panel-body" id="claimBody">
                        主張内容:我们围绕“中国的农业合作化运动是否正确选择”问题来简介图尔敏论证模型。对于农业合作化，一些人坚定地肯定，任何事实都不会动摇这些人肯定农业合作化的看法。另一些人，如陈小默，坚定地否定，任何事实也不会动摇这些人否定农业合作化的看法。
                        根据图尔敏的观点，论证不可能改变那些坚定分子。但是论证会使处于二者中间的不坚定分子感到某种观点是普乐好的（plausible）。
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="resultForm">
           <div class="row">
               <div  class="panel panel-info">
                   <div class="panel-body" id="resultFormBody">
                      <p>分析結果:</p>

                       <analysis-result></analysis-result>

                   </div>
               </div>
           </div>
        </div>



        <div class="row" id="input">
            <bottom-input></bottom-input>
        </div>


</div>


    <script>



                var myApp = angular.module("myChat",[])

                myApp.controller("chat",function($scope){
                    $scope.click = 0
                    function init(){
                       console.log("init.....")
                       $scope.analysisData = {txt:"Tシャツの相場は、500円から高くても4000円。対して、100,000円のTシャツなんて誰も買うわけがない。同じお金があれば、コート、カバン、時計、アクセサリーを買うに違いない。",analysisResult:[
                            {claim:"",support:[
                                {evidence:"",warrant:""},
                            ]},

                        ]}

                        $scope.inputStatus = {name:"claim",i:0,j:0}
                        //$scope.inputStatus = {name:"evidence",i:0,j:0}
                        //$scope.inputStatus = {name:"warrant",i:0,j:0}

                    }

                    init()


                })

                myApp.directive("concept",function(){
                    return {
                        scope:false,
                        templateUrl:"/angularJSTemplate/concept.html"
                    }
                })


                myApp.directive("bottomInput",function(){
                    return {
                        scope:false,
                        controller:function($scope,$rootScope){

                            function print(){
                                console.log($scope.analysisData.analysisResult)
                                $scope.contents = ""
                            }

                            function addIntoAnalysisData(name){
                                    var i = $scope.inputStatus.i
                                    var j = $scope.inputStatus.j
                                    if(name == "claim"){
                                        $scope.analysisData.analysisResult[i].claim = $scope.contents
                                    }

                                    if(name == "evidence"){
                                        $scope.analysisData.analysisResult[i].support[j].evidence = $scope.contents
                                    }

                                    if(name == "warrant"){
                                        $scope.analysisData.analysisResult[i].support[j].warrant = $scope.contents
                                    }
                            }

                            $scope.output = function(){
                                if($scope.inputStatus.name == "claim"){
                                    addIntoAnalysisData("claim")
                                    $scope.inputStatus.name = "evidence"
                               }else if($scope.inputStatus.name == "evidence"){
                                   addIntoAnalysisData("evidence")
                                   $scope.inputStatus.name = "warrant"
                                }else if($scope.inputStatus.name == "warrant"){
                                   addIntoAnalysisData("warrant")
                                   $scope.inputStatus.name = "newEvidence"
                                }else if($scope.inputStatus.name == "newEvidence"){

                               }else if($scope.inputStatus.name == "newClaim"){

                               }else{

                               }
                                print()
                                $rootScope.$broadcast('click',{});
                            }

                            $scope.noClaim = function(){
                                print()
                            }

                            $scope.noEvidence = function(){
                                $scope.inputStatus.name = "newClaim"
                            }

                            $scope.noWarrant = function(){
                                $scope.inputStatus.name = "newEvidence"
                            }

                            $scope.setNewClaim = function(){
                                $scope.inputStatus.i++
                                $scope.inputStatus.j = 0
                                $scope.inputStatus.name = "claim"
                                $scope.analysisData.analysisResult.push({claim:"",support:[
                                    {evidence:"",warrant:""}
                                ]})
                            }

                            $scope.setNewEvidence = function(){
                                var i = $scope.inputStatus.i
                                $scope.inputStatus.j++

                                $scope.analysisData.analysisResult[i].support.push(
                                    {evidence:"",warrant:""}
                                )
                                $scope.inputStatus.name ="evidence"
                            }



                        },
                        templateUrl:"/angularJSTemplate/bottomInput.html"
                    }
                })


                myApp.directive("analysisResult",function(){
                    return {
                        scope:false,
                        controller:function($scope){
                            var RECTWIDTH = 450
                            var RECTHEIGHT = 100
                            var OFFSETLEFT = 80
                            var OFFSETTOP = 40


                            var SPACECWH = 80   //interval between claim and warrant vertical
                            var SPACECCH = 100    //interval between claim and claim vertical
                            var SPACEWWH = 60  //interval between warrant and warrant vertical


                            var SPACECWW = 100   // interval between claim and warrant level
                            var SPACEWEW = 50   // interval between evidence and warrant level
                            var MAINLINEOFFSETLEFT = OFFSETLEFT + 40
                            var LASTY = 0
                            var LASTX = 0
                            var svg = d3.select("#mainSVG")

                            $scope.$on('click',function(event, data){
                                clearDraw()
                                draw()
                                drawMainArrow()
                            });


                            function clearDraw(){
                                svg.selectAll(".draw").remove()
                                LASTX = 0
                                LASTY = 0
                            }

                            function draw(){
                                LASTY += OFFSETTOP
                                LASTX += OFFSETLEFT


                                for(var i=0;i<$scope.analysisData.analysisResult.length;i++){
                                    appendRect($scope.analysisData.analysisResult[i].claim,LASTX,LASTY)


                                    for(var j=0;j<$scope.analysisData.analysisResult[i].support.length;j++){

                                        //先画warrant
                                        if(j==0){
                                            LASTY += (SPACECWH+RECTHEIGHT)
                                        }else{
                                            LASTY += (SPACEWWH+RECTHEIGHT)
                                        }

                                        LASTX += (SPACECWW)

                                        if($scope.analysisData.analysisResult[i].support[j].warrant){
                                            appendRect($scope.analysisData.analysisResult[i].support[j].warrant,LASTX,LASTY)
                                        }



                                        //再画evidence

                                        LASTX += (RECTWIDTH + SPACEWEW)

                                        appendRect($scope.analysisData.analysisResult[i].support[j].evidence,LASTX,LASTY)
                                        drawArrow(MAINLINEOFFSETLEFT,LASTX,LASTY+RECTHEIGHT/2,LASTY+RECTHEIGHT/2)
                                        LASTX -= (RECTWIDTH + SPACEWEW + SPACECWW)

                                    }


                                        LASTY += (SPACECCH + RECTHEIGHT)
                                }
                            }


                            function drawMainArrow(){
                                var mainLine = svg.insert("line",":first-child")
                                        .attr("x1",MAINLINEOFFSETLEFT)
                                        .attr("y1",OFFSETTOP+RECTHEIGHT)
                                        .attr("x2",MAINLINEOFFSETLEFT)
                                        .attr("y2",LASTY+RECTHEIGHT-((SPACECCH + RECTHEIGHT))-RECTHEIGHT/2)
                                        .attr("stroke","#9acfea")
                                        .attr("stroke-width",5)
                                        .attr("class","arrow draw")
                            }

                            function drawArrow(x1,x2,y1,y2){
                                var line = svg.insert("line",":first-child")
                                        .attr("x1",x1)
                                        .attr("y1",y1)
                                        .attr("x2",x2)
                                        .attr("y2",y2)
                                        .attr("stroke","#9acfea")
                                        .attr("stroke-width",3)
                                        .attr("class","arrow draw")
                            }









                            function appendRect(txt,x,y){
                                var foreignObject = svg.append("foreignObject")
                                foreignObject.attr("width",RECTWIDTH)
                                foreignObject.attr("height",RECTHEIGHT)

                                foreignObject.attr("x",x)
                                foreignObject.attr("y",y)

                                var div = foreignObject.append('xhtml:div')
                                var div = div.append("div")
                                div.attr("class","alert alert-info draw")
                                div.attr("role","alert")
                                div.attr("style","height: 100px; overflow: auto;")

                                var p = div.append("p")
                                p.html(txt)
                            }

                        },
                        templateUrl:"/angularJSTemplate/analysisResult.html"
                    }
                })
    </script>
</body>
</html>